# --- DOORBELL & SECURITY AUTOMATIONS ---

- id: 'doorbell_frigate_snapshot'
  alias: "Campainha - Snapshot Frigate ao Tocar"
  description: "Captura foto da c√¢mera do Frigate quando a campainha Intelbras √© acionada"
  trigger:
    - platform: state
      entity_id: binary_sensor.tuya_doorbell_button
      from: "off"
      to: "on"
  action:
    - vars:
        snapshot_path: "/config/www/snapshots/doorbell_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"
    
    - service: camera.snapshot
      target:
        entity_id: camera.frigate_front_door
      data:
        filename: "{{ snapshot_path }}"

    - service: notify.mobile_app_victor_mobile
      data:
        title: "Algu√©m na porta!"
        message: "A campainha foi tocada √†s {{ now().strftime('%H:%M') }}."
        data:
          image: "/local/snapshots/{{ snapshot_path.split('/')[-1] }}"
          clickAction: "/lovelace/cameras"

- id: 'porteiro_whatsapp_notification'
  alias: "Porteiro: Ao Receber Foto"
  description: "Dispara notifica√ß√£o WhatsApp via my-agents-api quando a foto da campainha atualiza"
  mode: single
  trigger:
    - platform: state
      entity_id: event.videoporteiro_doorbell_picture
  action:
    - service: rest_command.notificar_whatsapp_campainha
    - service: script.notify_doorbell
      data:
        camera_entity: camera.videoporteiro
        event_entity_picture: event.videoporteiro_doorbell_picture
        notify_device: mobile_app_victor_mobile
        title: "Ding Dong! üîî"
        message: "Algu√©m no port√£o (Foto recebida)."